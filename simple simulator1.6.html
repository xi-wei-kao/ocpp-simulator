<html>
  <head>
    <style>
      html,
      body {
        margin: 0;
        margin-left: 0.5rem
      }
      body {
        background: #000;
        color: white;
        font-family: Arial;
        /* height: 100vh !important; */
      }
      
      button,
      input,
      select {
        width: 100%;
        margin-bottom: 5px;
        cursor: pointer;
        height: 2rem;
      }

      button {
        background: #369;
        margin: 0.25rem;
        color: #fff;
        padding: 4px 12px;
        border: none;
        height: 2rem;
        width: fit-content;
        
      }

      ul {
        background: #000;
        color: #eee;
      }

      #red,
      #green,
      #blue {
        min-width: 10px;
      }

      #red {
        background-color: red;
      }

      #green {
        background-color: green;
      }

      #blue {
        background-color: blue;
      }

      #yellow {
        background-color: yellow;
      }
      .title {
        color: #27a3ac;
        text-align: center;
        animation: changeColor ease;
        animation-iteration-count: infinite;
        animation-duration: 4s;
        animation-fill-mode: both;
        font-size: 48px;
        padding: 0;
        margin: 0;
      }
      .subTitle {
        text-align: center;
        font-size: large;
      }
      @keyframes changeColor {
        0% {
          color: rgb(146, 213, 142);
        }

        50% {
          color: rgb(133, 184, 222);
        }

        100% {
          color: rgb(146, 213, 142);
        }
      }
      .metervalues {
        display: flex;
        text-align: center;
      }
      .container {
        display: flex;
        max-height: 100%;
      }
      .console {
        flex-grow: 1;
        flex-basis: 0;
        /* overflow: scroll; */
        max-height: 100%;
        /* background-color: cyan; */
      }
      .actions {
        flex-grow: 1;
        flex-basis: 0;
        margin: 1.5rem 0px;
      }
      .wrapper {
        max-height: 100%;
      }
      .meterTexts {
        flex-grow: 1;
        flex-basis: 0;
        text-align: left;
      }

      .box-container {
        padding: 0.5rem 0.5rem;
        margin: 0.5rem 0.25rem;
        border: 2px solid #efefef;
        border-radius: 1.5rem;
        box-shadow: #efefef50 3px 3px;
      }

      .form-label-layout {
        margin-bottom: 0.25rem;
        border-left: 0.1rem solid #ffffff;
        padding-left: 0.25rem;
      }

      .console-container {
        border: 2px solid #FFA07A;
        height: 60%;
        overflow: scroll;
        /* position: relative; */
      }
    </style>
  </head>

  <body>
    <div class="wrapper">
      <h1 class="title">INFINITY</h1>
      <p class="subTitle">Simple OCPP 1.6 Chargebox Simulator</p>
      <select style="display: none">
        <option value="">OCPP-J1.6</option>
      </select>
      <div class="container">
        <div class="actions">
          <div class="box-container">
            <h4>Metadata Configuration(åŸºæœ¬è¨­å®š)</h4>
            <hr/>
            <label class="form-label-layout">
              Central Stationã€ä¸­å¿ƒç³»çµ±é€£ç·šè³‡è¨Šï¼šhttp://ä¸»æ©Ÿip:åŸ è™Ÿ/å……é›»æ¨ç·¨è™Ÿã€‘
            </label>
            <!-- value="ws://localhost:2020/1076875101" -->
            <!-- value="wss://yds-stage.beseye.com:443/ocpp/1076875201" -->
            <!-- value="wss://yds-japan.beseye.com:443/ocpp/1076875101" -->
            <!-- value="wss://yds-dev.beseye.com:443/ocpp/1076875101" -->
            <!-- value="wss://gcsms.starcharger.com.tzw:443/ocpp/qeprodt70001??username=qeprodt70001&authKey=StarChargerAdmin" -->
            <!-- value="wss://yds-ms.beseye.com:443/ocpp/C01AL2405004" -->
            <!-- value-"wss://yds-jp-dev.beseye.com:443/ocpp/1076875101" -->
            <!-- value="wss://yds-jp-stage.beseye.com:443/ocpp/1076875101" -->
            <!-- value="wss://yds-dev.beseye.com:443/ocpp/SN2410191439" -->
            <!-- value="wss://yds-ms.beseye.com:443/ocpp/C01AL2405004" -->
            <!-- value="wss://yds-dev.beseye.com:443/ocpp/1076875101" -->
            <!-- value="wss://yds-stage.beseye.com:443/ocpp/C01AL2405004" -->
            <!-- value="wss://10.2.67.160:443/ocpp/CDCAA2ED2250001" -->
            <!-- value="wss://yds-eks-stage.beseye.com:443/ocpp/SN2406010327" -->
            <!-- value="wss://chargingpoint-proxy.beseye.com:443/ocpp/titan/ac/1076875101" -->
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <select id="server-select" style="max-width: 30%;">
                <option value="wss://yds-dev.beseye.com:443/ocpp/">å°ç£(dev):yds-dev.beseye.com</option>
                <option value="wss://yds-stage.beseye.com:443/ocpp/">å°ç£(stage):yds-stage.beseye.com</option>
                <option value="wss://yds-eks-stage.beseye.com:443/ocpp/">å°ç£(eks-stage):yds-eks-stage.beseye.com</option>
                <option value="wss://10.2.67.160:443/ocpp/">å°ç£(RT):10.2.67.160</option>
                <option value="/">---</option>
                <option value="wss://yds-jp-dev.beseye.com:443/ocpp/">æ—¥æœ¬(dev):yds-jp-dev.beseye.com</option>
                <option value="wss://yds-jp-stage.beseye.com:443/ocpp/">æ—¥æœ¬(stage):yds-jp-stage.beseye.com</option>
                <option value="/">---</option>
                <option value="wss://localhost:2020/">å°ç£(åœ°ç«¯local):localhost</option>
                <option value="wss://10.2.67.109:2020/">å°ç£(åœ°ç«¯109):10.2.67.109</option>
              </select>
              <input
                id="CP"
                type="text"
                value="1076875101"
                placeholder="Id Station"
              />
            </div>
            <hr/>
            <button id="connect">Connect</button>
          </div>

          <!-- Block: Core Profile Operation -->
          <div class="box-container">
            <h4>Actions - Core Profile(äº‹ä»¶æ“ä½œ)</h4>
            <hr/>

            <div style="display: flex; gap: 1rem; align-items: center">
                <button id="heartbeat">Heartbeat</button>
                <label>å……é›»æ¨æ™‚é–“æ…¢å¹¾ç§’?</label>
                <input 
                  type="number" 
                  id="latency-second" 
                  value="0"
                  style="max-width: 80px;" />
                <!-- <button id="test-flow-btn">æ¸¬è©¦æƒ…å¢ƒæµç¨‹</button> -->
            </div>
            <hr/>
            
            <!-- è‡ªè¨‚æ™‚é–“åŸºæº–è¨­å®š -->
            <div style="display: flex; flex-direction: column; gap: 0.5rem; padding: 0.5rem; background-color: #1a1a1a; border-radius: 0.5rem;">
              <label class="form-label-layout" style="color: #27a3ac;">æ™‚é–“åŸºæº–è¨­å®šï¼ˆæ‰€æœ‰timestampå°‡å¾æ­¤æ™‚é–“é–‹å§‹è¨ˆç®—ï¼‰</label>
              
              <!-- è‡ªå‹•åŒæ­¥é¸é … -->
              <div style="display: flex; gap: 0.5rem; align-items: center; padding: 0.5rem; background-color: #2a2a2a; border-radius: 0.25rem;">
                <input 
                  type="checkbox"
                  id="auto-sync-time" 
                  style="width: auto; margin: 0;"
                />
                <label style="margin: 0; cursor: pointer; color: #27a3ac;" for="auto-sync-time">
                  ğŸ”„ è‡ªå‹•åŒæ­¥ç³»çµ±æ™‚é–“ï¼ˆå¾ Heartbeat å›æ‡‰ï¼‰
                </label>
                <span id="last-sync-time" style="font-size: 0.85rem; color: #999; margin-left: auto;"></span>
              </div>

              <!-- æ‰‹å‹•è¨­å®šé¸é … -->
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input 
                  type="datetime-local" 
                  id="base-timestamp" 
                  style="max-width: 220px;"
                />
                <button id="apply-base-time" style="background-color: #27a3ac;">æ‰‹å‹•å¥—ç”¨åŸºæº–æ™‚é–“</button>
                <button id="reset-base-time" style="background-color: #666;">æ¢å¾©å¯¦éš›æ™‚é–“</button>
                <span id="time-mode-indicator" style="color: #999; font-weight: bold;">æ¨¡å¼: å¯¦éš›æ™‚é–“</span>
              </div>
              <div style="font-size: 0.85rem; color: #999;">
                èªªæ˜: å•Ÿç”¨è‡ªå‹•åŒæ­¥å¾Œï¼Œæ¯æ¬¡ Heartbeat å›æ‡‰éƒ½æœƒæ›´æ–°åŸºæº–æ™‚é–“ï¼›æˆ–å¯æ‰‹å‹•è¨­å®šåŸºæº–æ™‚é–“
              </div>
            </div>
            <hr/>

            <!-- Status Notification -->
            <div style="display: flex; gap: 0.5rem">
              <div style="max-width: 50%;">
                <label class="form-label-layout">Connector Status(å……é›»æ¨ç‹€æ…‹)</label>
                <select name="ConnectorStatus" id="ConnectorStatus" value="Available">
                  <option value="Available">Available</option>
                  <option value="Unavailable">Unavailable</option>
                  <option value="Faulted">Faulted</option>
                </select>
                <label class="form-label-layout">è¨­å®šç¡¬é«”å•†éŒ¯èª¤ä»£ç¢¼_VendorErrorCode(å……é›»æ¨)</label>
                <input id="cp-vendorErrorCode" type="text" placeholder="èª¿æ•´VendorErrorCode" value="" />
                <label class="form-label-layout">Connector uid(0ç‚ºå……é›»æ¨)</label>
                <input id="CUID" type="text" placeholder="Connector uid" value="0" disabled=true />
                <button id="status">Status Notification(å……é›»æ¨)</button>
              </div>
              <div>
                <label class="form-label-layout">Connector Status(å……é›»æ§ç‹€æ…‹)</label>
                <select name="ConnectorStatus" id="ConnectorStatus-connector">
                  <option value="Available">Available</option>
                  <option value="Preparing">Preparing</option>
                  <option value="Charging">Charging</option>
                  <option value="SuspendedEV">SuspendedEV</option>
                  <option value="SuspendedEVSE">SuspendedEVSE</option>
                  <option value="Finishing">Finishing</option>
                  <option value="Reserved">Reserved</option>
                  <option value="Faulted">Faulted</option>
                  <option value="Unavailable">Unavailable</option>
                </select>
                <label class="form-label-layout">è¨­å®šç¡¬é«”å•†éŒ¯èª¤ä»£ç¢¼_VendorErrorCode(å……é›»æ§)</label>
                <input id="connector-vendorErrorCode" type="text" placeholder="èª¿æ•´VendorErrorCode" value="" />
                <label class="form-label-layout">Connector uid(>=1ç‚ºå……é›»æ§)</label>
                <input id="CUID-connector" type="text" placeholder="Connector uid" value="1" />
                <button id="status-connector">Status Notification(å……é›»æ§)</button>
              </div>
            </div>
            <hr/>

            <div style="display: flex; gap: 0.75rem">
              <label class="form-label-layout">Tagã€å¡è™Ÿ, åå…­é€²ä½ã€‘</label>
              <a style="color: yellow" 
                target="_blank"
                href="https://tools.yeecord.com/zh-tw/base-converter/hex/dec">
                åƒè€ƒè½‰æ›ç¶²å€
              </a>
            </div>
            <input
              id="TAG"
              type="text"
              placeholder="Tag"
              value="32372EB1C92E0000"
            />
            <label class="form-label-layout">TransactionIdã€å……é›»äº¤æ˜“ID, æ–¼äº¤æ˜“å•Ÿå‹•è‡ªå‹•èª¿æ•´ã€‘</label>
            <input
              id="transactionId"
              type="text"
              placeholder="transactionId"
              value="1"
            />
            <button id="send">Authorize</button>
            <button id="start">Start Transaction</button>
            <label>å……å¹¾åˆ†é˜</label>
            <input
              id="duration"
              type="number"
              placeholder="duration"
              value="0"
              style="max-width: 100px;"
            />
            <button id="stop">Stop Transaction</button>
            <button id="data_transfer">Data Tranfer</button>
            <hr/>

            <!-- MeterValues -->
            <div>
              <label>Meter value: electricityã€é›»é‡(å–®ä½: ç“¦å°æ™‚, Kh)ã€‘</label>
              <input
                id="metervalue"
                type="text"
                placeholder="Meter value"
                value="15000"
              />
              <label>Meter value: powerã€åŠŸç‡(å–®ä½: ç“¦ç‰¹, W)ã€‘</label>
              <input
                id="metervaluePower"
                type="text"
                placeholder="Meter value"
                value="7000"
              />
              <label>Meter value: currentã€é›»æµ(å–®ä½: å®‰åŸ¹, A)ã€‘</label>
              <input
                id="metervalueCurrnet"
                type="text"
                placeholder="Meter value"
                value="32"
              />
              <label>Meter value: voltageã€é›»å£“(å–®ä½: ä¼ç‰¹, V)ã€‘</label>
              <input
                id="metervalueVoltage"
                type="text"
                placeholder="Meter value"
                value="220"
              />
              <label>Meter value: SoCã€é›»æ± æ¯”ç‡(å–®ä½: æ¯”ç‡, %)ã€‘</label>
              <input
                id="metervalueSoC"
                type="text"
                placeholder="Meter value"
                value="0"
              />
              <div style="display: inline-flex; gap: 1rem; align-items: center">
                <label>å‚³å…¥æ ¼å¼å…§å®¹</label>
                <label>æ–·ç·šäº†å¹¾åˆ†é˜å‚³å…¥?</label>
                <input
                  id="disconnectMins"
                  type="number"
                  placeholder="disconnectMins"
                  value="0"
                  style="max-width: 120px"
                />
              </div>
              <div style="height: 200px; overflow-y: scroll;">
                <pre id="metervalueDisplay"></pre>
              </div>
              <div style="display: flex; margin-top: 0.5rem">
                <button id="mv" style="min-width: 160px;">Send Meter Values</button>
                <div style="display: inline-flex; align-items: center">
                  <input 
                    type="checkbox"
                    id="isPeriodSend" />
                  <label style="min-width: 120px;">æ˜¯å¦å®šæœŸç™¼é€?</label>
                </div>
                <div style="display: flex; align-items: center; gap: 0.25rem">
                  <input 
                    type="number"
                    id="meterValuesInterval"
                    value="10"
                    style="max-width: 120px;" />
                    <label style="min-width: 100px;">ç™¼é€é–“éš”(ç§’)</label>
                  <div>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1024"
                      id="meterInterInfo"
                      style="width: 36px; height: 36px;">
                      <path fill="currentColor" d="M512 64a448 448 0 1 1 0 896.064A448 448 0 0 1 512 64m67.2 275.072c33.28 0 60.288-23.104 60.288-57.344s-27.072-57.344-60.288-57.344c-33.28 0-60.16 23.104-60.16 57.344s26.88 57.344 60.16 57.344M590.912 699.2c0-6.848 2.368-24.64 1.024-34.752l-52.608 60.544c-10.88 11.456-24.512 19.392-30.912 17.28a12.992 12.992 0 0 1-8.256-14.72l87.68-276.992c7.168-35.136-12.544-67.2-54.336-71.296-44.096 0-108.992 44.736-148.48 101.504 0 6.784-1.28 23.68.064 33.792l52.544-60.608c10.88-11.328 23.552-19.328 29.952-17.152a12.8 12.8 0 0 1 7.808 16.128L388.48 728.576c-10.048 32.256 8.96 63.872 55.04 71.04 67.84 0 107.904-43.648 147.456-100.416z">
                      </path>
                    </svg>
                    <div style="position: absolute; z-index: 999; margin-top: 4px">
                      <div 
                        id="meterValueInfoContainer"
                        style="background-color: 
                              #ffffff; border-radius: 0.5rem;
                              padding: 8 12;
                              display: none">
                        <span style="color: #000;">å®šæœŸç™¼é€è¨Šè™Ÿæ¯æ¬¡æœƒå¢åŠ "50Wh"åº¦æ•¸</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- Firmware æ“ä½œå€å¡Š -->
          <div class="box-container">
            <h4>Actions - Firmware Management Profile(äº‹ä»¶æ“ä½œ)</h4>
            <hr/>

            <div style="margin-top: 1rem; margin-bottom: 1rem;">
              <div>
                <label class="form-label-layout">listVersion</label>
              </div>
              <input
                id="listVersion"
                type="number"
                placeholder="listVersion"
                value="0"
              />
              <label class="form-label-layout">Send Local List Statusã€test other status return!(Default Accepted)ã€‘</label>
              <select name="SendLocalListStatus" id="SendLocalListStatus">
                <option value="Accepted">Accepted</option>
                <option value="Failed">Failed</option>
                <option value="NotSupported">NotSupported</option>
                <option value="VersionMismatch">VersionMismatch</option>
              </select>
            </div>
            <hr/>

            <div>
              <label>Diagnostics Statusã€è¨ºæ–·å ±å‘Šç‹€æ…‹å›å ±ã€‘</label>
              <select name="DiagnosticsStatus" id="DiagnosticsStatus">
                <option value="Idle">Idle</option>
                <option value="Uploaded">Uploaded</option>
                <option value="UploadFailed">UploadFailed</option>
                <option value="Uploading">Uploading</option>
              </select>
              <button id="Diagnostics-Status-Notification" style="background-color: #27a3ac;">Diagnostics Status Notification</button>
            </div>
            <hr/>

            <div>
              <label>Firmware Statusã€éŸŒé«”æ›´æ–°ç‹€æ…‹å›å ±ã€‘</label>
              <select name="FirmwareStatus" id="FirmwareStatus">
                <option value="Downloaded">Downloaded</option>
                <option value="DownloadFailed">DownloadFailed</option>
                <option value="Downloading">Downloading</option>
                <option value="Idle">Idle</option>
                <option value="InstallationFailed">InstallationFailed</option>
                <option value="Installing">Installing</option>
                <option value="Installed">Installed</option>
              </select>
              <button id="Firmware-Status-Notification" style="background-color: #27a3ac;">Firmware Status Notification</button>
            </div>
          </div>
        </div>
        <div class="console">
          <div style="display: flex; align-items: center">
            <div>
              <span class="indicator" id="red">____</span>
              <span class="indicator" id="green">____</span>
              <span class="indicator" id="blue">____</span>
              <span class="indicator" id="yellow">____</span>
            </div>
            <div>
              <button id="clear-console-btn">æ¸…é™¤ä¸»æ§å°</button>
            </div>
          </div>
          <!-- è¨»è§£å€å¡Š, è‡ªå®šç¾©è¨Šæ¯ -->
          <!-- <div style="padding: 1rem">
            <label>message</label>
            <input
              id="message-input"
              type="text"
              value=""
            />
            <button id="cus-send" style="margin-top: 0.75rem">send</button>
            <pre id="message-preview"></pre>
          </div> -->
          <div class="console-container">
            <ul id="console"></ul>
          </div>
        </div>
      </div>
    </div>
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"
    ></script>

    <script>
      var timesRun = 0;

      var c = 0;
      var possible =
        "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
      var id = randomId();
      var _websocket = null;
      var connector_locked = false;

      const chargingStatus = [
        "Charging", "SuspendedEVSE", "SuspendedEV"
      ]

      window.onload = () => {
        sessionStorage.setItem("LastAction", "");
      }

      // å®šæœŸæª¢æŸ¥é‡å•Ÿ (å·²ç§»é™¤ï¼Œæ”¹ç‚ºç›´æ¥åœ¨ Reset è™•ç†ä¸­è™•ç†)
      
      // æ™‚é–“åŸºæº–ç›¸é—œè®Šæ•¸
      var baseTimestamp = null;  // ç”¨æˆ¶è¨­å®šçš„åŸºæº–æ™‚é–“
      var baseRealTime = null;   // æŒ‰ä¸‹å¥—ç”¨æŒ‰éˆ•æ™‚çš„å¯¦éš›æ™‚é–“
      var useCustomTime = false; // æ˜¯å¦ä½¿ç”¨è‡ªè¨‚æ™‚é–“æ¨¡å¼
      
      // è«‹æ±‚è¿½è¹¤ï¼šè¨˜éŒ„æ¯å€‹ messageId å°æ‡‰çš„ action å’Œ payload
      var requestTracker = {};
      
      // é‡å•Ÿå‰ç‹€æ…‹ä¿å­˜ï¼šè¨˜éŒ„é‡å•Ÿå‰çš„å……é›»æ¨å’Œå……é›»æ§ç‹€æ…‹
      var savedStatusBeforeReset = {
        chargePointStatus: null,    // å……é›»æ¨ç‹€æ…‹ (connectorId=0)
        connectorStatus: null,       // å……é›»æ§ç‹€æ…‹ (connectorId=1)
        connector2Status: null       // ç¬¬äºŒéš»å……é›»æ§ç‹€æ…‹ (connectorId=2)
      };
      
      // å……é›»æ§æ•¸é‡é…ç½® (1 æˆ– 2)
      var connectorCount = 2;  // è¨­å®šç‚º 2 éš»æ§

      // æ¸…é™¤ä¸»æ§å°
      $("#clear-console-btn").on("click", () => {
        $("#console").html("");
      })

      /**
       * çµ±ä¸€çš„æ™‚é–“å–å¾—å‡½æ•¸
       * å¦‚æœå•Ÿç”¨è‡ªè¨‚æ™‚é–“æ¨¡å¼ï¼Œå‰‡è¿”å›ã€åŸºæº–æ™‚é–“ + å¾å•Ÿç”¨å¾Œç¶“éçš„æ™‚é–“ - å»¶é²ç§’æ•¸ã€‘
       * å¦å‰‡è¿”å›ã€ç•¶å‰å¯¦éš›æ™‚é–“ - å»¶é²ç§’æ•¸ã€‘
       */
      function getCurrentTimestamp() {
        const latencySecond = Number($("#latency-second").val()) || 0;
        
        if (useCustomTime && baseTimestamp && baseRealTime) {
          // è¨ˆç®—å¾å•Ÿç”¨è‡ªè¨‚æ™‚é–“å¾Œç¶“éäº†å¤šå°‘æ¯«ç§’
          const elapsedMs = Date.now() - baseRealTime;
          // åŸºæº–æ™‚é–“ + ç¶“éæ™‚é–“ - å»¶é²ç§’æ•¸
          const resultTime = new Date(baseTimestamp.getTime() + elapsedMs);
          resultTime.setSeconds(resultTime.getSeconds() - latencySecond);
          return resultTime;
        } else {
          // ä½¿ç”¨å¯¦éš›æ™‚é–“
          const now = new Date();
          now.setSeconds(now.getSeconds() - latencySecond);
          return now;
        }
      }
      
      /**
       * ç™¼é€ OCPP è«‹æ±‚ä¸¦è¿½è¹¤
       */
      function sendOcppRequest(action, payload) {
        const message = [2, id, action, payload];
        const messageJson = JSON.stringify(message);
        
        // è¨˜éŒ„è«‹æ±‚ä»¥ä¾¿è¿½è¹¤éŒ¯èª¤
        requestTracker[id] = {
          action: action,
          payload: payload,
          fullJson: messageJson,
          sentTime: new Date().toISOString()
        };
        
        // ç™¼é€
        _websocket.send(messageJson);
        
        return messageJson;
      }
      
      function randomId() {
        id = "";
        for (var i = 0; i < 36; i++) {
          id += possible.charAt(Math.floor(Math.random() * possible.length));
        }
        return id;
      }

      function wsConnect() {
        var wsurl = $("#server-select").val();
        var CP = $("#CP").val();

        if (_websocket) {
          $("#red").show();
          _websocket.close(3001);
        } else {
          console.log("connect ==>", wsurl + CP);
          /*
          const connectorHeaders = {
            "Authorization": "StarChargerAdmin",
          }
          */
          const connectorHeaders = {
            "username": CP,
            "password": "StarChargerAdmin"
          }

          _websocket = new WebSocket(wsurl + CP, ["ocpp1.6", "ocpp1.5"], { connectorHeaders });
          _websocket.onopen = function (authorizationData) {
            /*
            // æ¡æ‰‹æˆåŠŸå¾Œä¸»å‹•é€å‡ºèªè­‰è³‡è¨Š
            const username = CP;
            const password = "StarChargerAdmin";
            ws.send(username);                         // å°æ‡‰ server çš„ String s
            ws.send(new TextEncoder().encode(password)); // å°æ‡‰ server çš„ byte[] bytes
            */

            // æª¢æŸ¥æ˜¯å¦ç‚ºé‡å•Ÿå¾Œçš„é€£ç·š
            const lastAction = sessionStorage.getItem("LastAction");
            const isResetReconnect = lastAction === "Reset";
            
            if (!isResetReconnect) {
              // éé‡å•Ÿé€£ç·šï¼Œè¨­å®šç‚º BootNotification
              sessionStorage.setItem("LastAction", "BootNotification");
            }
            
            $("#yellow").show();
            BootNotification();
            $("#connect").text("Disconnect").css("background", "green");
            
            // å¦‚æœæ˜¯é‡å•Ÿå¾Œçš„é€£ç·šï¼Œç™¼é€ç‹€æ…‹é€šçŸ¥
            if (isResetReconnect) {
              setTimeout(() => {
                logMsg("ğŸ”„ é‡å•Ÿå¾Œç™¼é€ç·šä¸Šç‹€æ…‹é€šçŸ¥");
                sendOnlineStatusNotifications();
                sessionStorage.setItem("LastAction", ""); // æ¸…é™¤é‡å•Ÿæ¨™è¨˜
                logMsg("âœ… é‡å•Ÿæµç¨‹å®Œæˆï¼");
              }, 3000); // ç­‰å¾… BootNotification å®Œæˆå¾Œå†ç™¼é€ç‹€æ…‹
            }
          };

          _websocket.onmessage = function (msg) {
            // console.log("msg = ", msg);
            c++;
            var ddata = JSON.parse(msg.data);
            console.log(ddata);
            if (c == 1) {
              var hb_interval = handleData(ddata);
              sessionStorage.setItem("Configuration", hb_interval);
              startHB(hb_interval * 1000);
            }

            if (ddata[0] === 3) {
              logMsg(`Data exchange successful! payload: ${JSON.stringify(ddata)}`);
              
              // æª¢æŸ¥æ˜¯å¦ç‚º Heartbeat å›æ‡‰ï¼Œä¸¦è™•ç†è‡ªå‹•åŒæ­¥æ™‚é–“
              var lastAction = sessionStorage.getItem("LastAction");
              if (lastAction === "Heartbeat" && ddata[2].currentTime) {
                const systemTime = ddata[2].currentTime;
                logMsg(`ğŸ“¡ æ”¶åˆ°ç³»çµ±æ™‚é–“: ${systemTime}`);
                
                // å¦‚æœå•Ÿç”¨è‡ªå‹•åŒæ­¥ï¼Œå‰‡è‡ªå‹•è¨­å®šåŸºæº–æ™‚é–“
                if ($("#auto-sync-time").is(":checked")) {
                  const systemDate = new Date(systemTime);
                  baseTimestamp = systemDate;
                  baseRealTime = Date.now();
                  useCustomTime = true;
                  
                  const localTimeStr = systemDate.toLocaleString('zh-TW', { 
                    timeZone: 'Asia/Taipei',
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                  });
                  
                  $("#time-mode-indicator").text("æ¨¡å¼: è‡ªå‹•åŒæ­¥").css("color", "#27a3ac");
                  $("#last-sync-time").text(`ä¸Šæ¬¡åŒæ­¥: ${localTimeStr}`);
                  logMsg(`ğŸ”„ å·²è‡ªå‹•åŒæ­¥ç³»çµ±æ™‚é–“ç‚ºåŸºæº–`);
                  console.log("è‡ªå‹•åŒæ­¥æ™‚é–“:", systemDate.toISOString());
                }
              }
              
              var transactionId = ddata[2].transactionId;
              if (transactionId) {
                $("#transactionId").val(transactionId);
              }
              logMsg("Response: " + JSON.stringify(ddata[2]));
            } else if (ddata[0] === 4) {
              // CALLERROR: [4, messageId, errorCode, errorDescription, errorDetails]
              const messageId = ddata[1];
              const errorCode = ddata[2];
              const errorDesc = ddata[3] || '(ç„¡æè¿°)';
              const errorDetails = ddata[4];
              
              // å¾è¿½è¹¤å™¨ä¸­æ‰¾å‡ºåŸå§‹è«‹æ±‚
              const originalRequest = requestTracker[messageId];
              
              let errorMsg = `
âŒ CALLERROR - å¾Œç«¯æ‹’çµ•è«‹æ±‚ï¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€éŒ¯èª¤è³‡è¨Šã€‘
  ErrorCode: ${errorCode}
  ErrorDescription: ${errorDesc}
  ErrorDetails: ${JSON.stringify(errorDetails)}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;

              if (originalRequest) {
                errorMsg += `
ã€åŸå§‹è«‹æ±‚ã€‘
  Action: ${originalRequest.action}
  MessageId: ${messageId}
  ç™¼é€æ™‚é–“: ${originalRequest.sentTime}
  Payload: ${JSON.stringify(originalRequest.payload, null, 2)}
  å®Œæ•´JSON: ${originalRequest.fullJson}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;
                
                // æ¸…ç†è¿½è¹¤è¨˜éŒ„
                delete requestTracker[messageId];
              } else {
                errorMsg += `
ã€åŸå§‹è«‹æ±‚ã€‘(è¿½è¹¤è¨˜éŒ„æœªæ‰¾åˆ°)
  MessageId: ${messageId}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;
              }
              
              logMsg(errorMsg);
              console.error("âŒ CALLERROR å®Œæ•´è³‡è¨Š:", {
                error: ddata,
                originalRequest: originalRequest
              });
            } else if (JSON.parse(msg.data)[0] === 2) {
              logMsg(JSON.parse(msg.data)[2]);
              id = JSON.parse(msg.data)[1];

              switch (ddata[2]) {
                case "ChangeConfiguration":
                  var ChangeConf = JSON.stringify([3, id, { status: "Accepted" }]);
                  logMsg("æ¥æ”¶ChangeConfig");
                  _websocket.send(ChangeConf);
                  // setTimeout(() => {
                  // }, 4000)
                  break;

                case "Reset":
                  //Reset type SOFT, HARD
                  var ResetS = JSON.stringify([3, id, { status: "Accepted" }]);
                  console.log("Reset å³å°‡é€å‡º");
                  _websocket.send(ResetS);
                  
                  // é‡å•Ÿå‰ï¼šä¿å­˜ç•¶å‰ç‹€æ…‹
                  logMsg("ğŸ”„ é‡å•Ÿå‰ä¿å­˜ç•¶å‰ç‹€æ…‹");
                  saveStatusBeforeReset();
                  
                  // è¨­å®šé‡å•Ÿæ¨™è¨˜
                  sessionStorage.setItem("LastAction", "Reset");
                  
                  // æ¨¡æ“¬é‡å•Ÿï¼šé—œé–‰ WebSocket é€£ç·š
                  logMsg("ğŸ”„ æ¨¡æ“¬é‡å•Ÿï¼šé—œé–‰é€£ç·š");
                  setTimeout(() => {
                    if (_websocket) {
                      _websocket.close(3001); // é—œé–‰é€£ç·šæ¨¡æ“¬é‡å•Ÿ
                      _websocket = null;
                    }
                  }, 1000); // 1ç§’å¾Œé—œé–‰é€£ç·š
                  
                  // é‡æ–°é€£ç·š
                  setTimeout(() => {
                    console.log("--- é‡å•Ÿé‡è©¦ ---");
                    logMsg("ğŸ”„ é‡å•Ÿå¾Œé‡æ–°é€£ç·š");
                    wsConnect();
                  }, 3000); // 3ç§’å¾Œé‡æ–°é€£ç·š
                  break;
                case "RemoteStopTransaction":
                  //TransactionID
                  var remStp = JSON.stringify([3, id, { status: "Accepted" }]);
                  _websocket.send(remStp);

                  $("#transactionId").val(JSON.parse(msg.data)[3].transactionId);
                  
                  // èª¿æ•´ç‹€æ…‹ç‚ºçµæŸå……é›», è§¸ç™¼æŒ‰éˆ•äº‹ä»¶
                  // 1. çµæŸäº¤æ˜“å‰, å…ˆå‚³å…¥çš„çµæŸç‹€æ…‹(venderErrorCode="0x100203")
                  
                  // 2. çµæŸäº¤æ˜“å‰, æœ€å¾Œä¸€ç­† MeterValues
                  // send_meterValue();
                  
                  // 4. çµæŸäº¤æ˜“å¾Œæ‹”æ§(Available)
                  stopTransaction();
                  
                  // $("#connector-vendorErrorCode").val("0x200008");
                  triggerStatus("Finishing");
                  // $("#connector-vendorErrorCode").val("");
                  // triggerStatus("Available");
                  
                  $(".indicator").hide();
                  $("#yellow").show();
                  break;
                case "RemoteStartTransaction":
                  //Need to get idTag, connectorId (map - ddata[3])
                  $("#TAG").val(ddata[3].idTag);
                  console.log("RemostartTransaction ddata[3].idTag = ", ddata[3].idTag);
                  var remStrt = JSON.stringify([3, id, { status: "Accepted" }]);
                  _websocket.send(remStrt);

                  // æ¸¬è©¦ etreego Auto-Charge å•é¡Œ(æ˜¯ä¸æ˜¯åœ¨Remoteå¾Œæ‰æ”¶åˆ°Auth)
                  setTimeout(() => {
                    Authorize()
                  }, 2000);
                  
                  /*
                  // è‹¥ç‚ºæ‹”æ§ç‹€æ…‹('Available'), å‰‡å…ˆé€²å…¥æº–å‚™('Preparing'), éä¹‹å¾Œæ‰æœƒé€²å……
                  const currentStatus = $("#ConnectorStatus-connector").val();
                  if (currentStatus === "Available") {
                    setTimeout(() => {
                      triggerStatus("Preparing");
                    }, 500);
                  }
                  */
                  
                  // æœ€å¾Œé€²å……
                  setTimeout(() => {
                    startTransaction();
                  }, 3000);

                  break;
                case "UnlockConnector": /////////ERROR!!!!!!!!
                  //connectorId
                  var UC = JSON.stringify([3, id, { status: "Accepted" }]);
                  console.log("è§£é–å³å°‡é€å‡º");
                  _websocket.send(UC);
                  // connector_locked = false;
                  // $('.indicator').hide();
                  //$('#yellow').show();
                  //logMsg("Connector status changed to: "+connector_locked);
                  break;
                case "TriggerMessage":
                  // Called by CPMS asking ChargePoint to execute the instruction
                  // Implemented for MeterValues
                  logMsg(`Trigger Message Type: ${ddata[3].requestedMessage}`);

                  switch (ddata[3].requestedMessage) {
                    case "MeterValues" :
                      var remStrt = JSON.stringify([3, id, { status: "Accepted" }]);
                      _websocket.send(remStrt);
                      send_meterValue();
                    break;
                    default : 
                      var error = JSON.stringify([4, id]);
                      _websocket.send(error);
                  }

                  break;
                case "SetChargingProfile":
                  console.log("SetChargingProfile ddata = ", ddata);
                  const setChargingProfile = JSON.parse(msg.data)[3];
                  const profile = setChargingProfile.csChargingProfiles;
                  logMsg("================================================");
                  logMsg("--- å……é›»è¨­å®š ------------------------------------------------------------");
                  const cpId = $("#CP").val().toString();
                  logMsg(`æ¨é«”è™Ÿ: ${cpId}`);
                  logMsg(`connectorId(åˆ†é…æ§è™Ÿ 0ç‚ºLoad-Balancingæ¨¡å¼): ${setChargingProfile.connectorId}`);
                  logMsg(`chargingProfileKind(åˆ†é…è¦å‰‡): ${profile.chargingProfileKind}`);
                  logMsg(`chargingProfilePurpose(åˆ†é…é¡å‹): ${profile.chargingProfilePurpose}`);
                  logMsg(`chargingRateUnit(å–®ä½): ${profile.chargingSchedule.chargingRateUnit}`);
                  logMsg(`chargingSchedulePeriod(å¥—ç”¨): ${profile.chargingSchedule.chargingSchedulePeriod[0].limit}`);
                  logMsg("--- å……é›»è¨­å®š ------------------------------------------------------------");
                  logMsg("================================================");
                  var SCP = JSON.stringify([3, id, { status: "Accepted" }]);
                  console.log("ä¿®æ”¹å……é›»è¨­å®šå³å°‡é€å‡º");
                  _websocket.send(SCP);
                  break;
                case "ClearChargingProfile":
                  var CCP = JSON.stringify([3, id, { status: "Accepted" }]);
                  _websocket.send(CCP);
                  break;
                
                // æ–°å¢ Local Auth List Management & Firmware Management ç›¸é—œ CMS äº‹ä»¶æ¥æ”¶å¾Œå›æ‡‰
                // Local Auth List Management
                case "GetLocalListVersion":
                  var GLLV = JSON.stringify([3, id, { listVersion: 1 }]);
                  _websocket.send(GLLV);
                  break;
                case "SendLocalList":
                  var SLL = JSON.stringify([3, id, { status: $("#SendLocalListStatus").val() }]);
                  _websocket.send(SLL);
                  break;
                // Firmware Management
                case "GetDiagnostics":
                  var GD = JSON.stringify([3, id, { fileName: "abc.log" }]);
                  _websocket.send(GD);
                  break;
                case "UpdateFireware":
                  var UF = JSON.stringify([3, id, {}]);
                  _websocket.send(UF);
                  break;

                // ç¦ç”¨/è§£é™¤ç¦ç”¨
                case "ChangeAvailability":
                  const isCharging = chargingStatus.includes($("#ConnectorStatus-connector").val());
                  var CA = JSON.stringify([3, id, { status: isCharging ? "Rejected" : "Accepted"  }]);
                  // å……é›»ä¸­æš«æ™‚é˜»æ“‹ç¦ç”¨(å¯¦éš›ç‚ºé€²å…¥"Scheduled")
                  if (isCharging) {
                    _websocket.send(CA);
                    break;
                  }
                  // è‹¥ç‚ºæ¨(ConnectorId="0")ç¦ç”¨, å‰‡å»£æ’­ç‹€æ…‹äº‹ä»¶
                  const isOperative = ddata[3].type === "Operative";
                  if (ddata[3].connectorId === 1) {
                    triggerStatusEVSE(isOperative ? "Available" : "Unavailable");
                  }
                  triggerStatus(isOperative ? "Available" : "Unavailable");
                  _websocket.send(CA);
                  break;

                // Reservation
                case "ReserveNow":
                  logMsg("ReserveNow");
                  var RN = JSON.stringify([3, id, { status: "Accepted" }]);
                  _websocket.send(RN);
                  // ç™¼é€é ç´„ç‹€æ…‹
                  triggerStatus("Reserved");
                  break;
                case "CancelReservation":
                  var CR = JSON.stringify([3, id, { status: "Accepted" }]);
                  _websocket.send(CR);
                  logMsg("é ç´„å–æ¶ˆ");
                  // å›åˆ°å¯ç”¨ç‹€æ…‹
                  triggerStatus("Available");
                  break;
                default:
                  var error = JSON.stringify([4, id]);
                  _websocket.send(error);
                  break;
              }
            }
          };

          _websocket.onclose = function (evt) {
            $("#connect").text("Connect").css("background", "#369");
            if (evt.code == 3001) {
              logMsg("ws closed");
              _websocket = null;
            } else {
              logMsg("ws connection error: " + evt.code);
              $("#console").html("");
              _websocket = null;
              wsConnect();
            }
          };

          _websocket.onerror = function (evt) {
            if (_websocket.readyState == 1) {
              $("#red").show();
              logMsg("ws normal error: " + evt.type);
            }
          };
        }
      }


      function checkResrvedStart() {
        const currentStatus = $("#ConnectorStatus-connector").val();
        if (currentStatus !== "Reserved") {
          triggerStatus("Charging");
        }
      }

      function logMsg(err) {
        console.log(err);
        $("#console").append("<li>" + err + "</li>");
      }

      function triggerStatusEVSE(status) {
        const statusCheck = [
          "Available", "Unavailable", "Faulted"
        ]
        if (statusCheck.includes(status)) {
          document.getElementById("ConnectorStatus").value = status;
          setTimeout(() => {
            document.getElementById("status-connector").dispatchEvent(new Event("click"));
          }, 300);
          logMsg(`æ¨ç‹€æ…‹åˆ‡æ›: ${status}`);
        }
      }

      function triggerStatus(status) { 
          // èª¿æ•´ç‹€æ…‹, ä¸¦è§¸ç™¼æŒ‰éˆ•äº‹ä»¶
          document.getElementById("ConnectorStatus-connector").value = status;
          setTimeout(() => {
            document.getElementById("status-connector").dispatchEvent(new Event("click"));
          }, 300);
       }

      /**
       * é‡å•Ÿå‰ä¿å­˜ç•¶å‰ç‹€æ…‹
       * å¾ UI å…ƒç´ ä¸­è®€å–ç•¶å‰çš„å……é›»æ¨å’Œå……é›»æ§ç‹€æ…‹
       */
      function saveStatusBeforeReset() {
        // ä¿å­˜å……é›»æ¨ç‹€æ…‹ (connectorId=0)
        savedStatusBeforeReset.chargePointStatus = $("#ConnectorStatus").val();
        
        // æ ¹æ“š CUID-connector çš„å€¼ä¾†åˆ¤æ–·æ˜¯å“ªä¸€éš»å……é›»æ§
        const currentConnectorId = parseInt($("#CUID-connector").val());
        const currentConnectorStatus = $("#ConnectorStatus-connector").val();
        
        // ä¿å­˜ç•¶å‰è¨­å®šçš„å……é›»æ§ç‹€æ…‹
        if (currentConnectorId === 1) {
          savedStatusBeforeReset.connectorStatus = currentConnectorStatus;
        } else if (currentConnectorId === 2) {
          savedStatusBeforeReset.connector2Status = currentConnectorStatus;
        }
        
        // ç‚ºäº†æ”¯æ´å…©éš»å……é›»æ§ï¼Œæˆ‘å€‘éœ€è¦è¨­å®šé è¨­ç‹€æ…‹
        // å¦‚æœæ²’æœ‰è¨­å®šç¬¬äºŒéš»å……é›»æ§çš„ç‹€æ…‹ï¼Œä½¿ç”¨é è¨­å€¼
        if (!savedStatusBeforeReset.connectorStatus) {
          savedStatusBeforeReset.connectorStatus = "Available"; // é è¨­ç¬¬ä¸€éš»æ§ç‚º Available
        }
        if (!savedStatusBeforeReset.connector2Status) {
          savedStatusBeforeReset.connector2Status = "Preparing"; // é è¨­ç¬¬äºŒéš»æ§ç‚º Preparing
        }
        
        logMsg(`ğŸ’¾ å·²ä¿å­˜é‡å•Ÿå‰ç‹€æ…‹:`);
        logMsg(`   å……é›»æ¨ (connectorId=0): ${savedStatusBeforeReset.chargePointStatus}`);
        logMsg(`   å……é›»æ§1 (connectorId=1): ${savedStatusBeforeReset.connectorStatus}`);
        logMsg(`   å……é›»æ§2 (connectorId=2): ${savedStatusBeforeReset.connector2Status}`);
        
        // å°‡ç‹€æ…‹ä¿å­˜åˆ° sessionStorage ä»¥é˜²é é¢åˆ·æ–°
        sessionStorage.setItem("savedStatusBeforeReset", JSON.stringify(savedStatusBeforeReset));
      }


      /**
       * é‡å•Ÿå¾Œç™¼é€ç·šä¸Šç‹€æ…‹é€šçŸ¥
       * æ¢å¾©é‡å•Ÿå‰ä¿å­˜çš„å……é›»æ¨å’Œå……é›»æ§ç‹€æ…‹
       */
      function sendOnlineStatusNotifications() {
        const timestamp = getCurrentTimestamp();
        
        // å¾ sessionStorage è®€å–ä¿å­˜çš„ç‹€æ…‹
        const savedStatus = sessionStorage.getItem("savedStatusBeforeReset");
        let statusToRestore = savedStatusBeforeReset;
        
        if (savedStatus) {
          try {
            statusToRestore = JSON.parse(savedStatus);
            logMsg(`ğŸ“– å¾ sessionStorage è®€å–ä¿å­˜çš„ç‹€æ…‹: ` + statusToRestore);
          } catch (e) {
            logMsg(`âš ï¸ è®€å–ä¿å­˜ç‹€æ…‹å¤±æ•—ï¼Œä½¿ç”¨é è¨­ç‹€æ…‹`);
          }
        }
        
        // ç™¼é€å……é›»æ¨ç‹€æ…‹ (connectorId=0)
        const cpStatus = statusToRestore.chargePointStatus || "Available";
        const cpPayload = {
          connectorId: 0,
          status: cpStatus,
          errorCode: "NoError", 
          timestamp: timestamp.toISOString()
        };
        sendOcppRequest("StatusNotification", cpPayload);
        logMsg(`ğŸ“¤ ç™¼é€å……é›»æ¨ç‹€æ…‹: connectorId=0, status=${cpStatus}`);
        
        // ç™¼é€ç¬¬ä¸€éš»å……é›»æ§ç‹€æ…‹ (connectorId=1)
        const connector1Status = statusToRestore.connectorStatus || "Available";
        const connector1Payload = {
          connectorId: 1,
          status: connector1Status,
          errorCode: "NoError",
          timestamp: timestamp.toISOString()
        };
        sendOcppRequest("StatusNotification", connector1Payload);
        logMsg(`ğŸ“¤ ç™¼é€å……é›»æ§1ç‹€æ…‹: connectorId=1, status=${connector1Status}`);
        
        // ç™¼é€ç¬¬äºŒéš»å……é›»æ§ç‹€æ…‹ (connectorId=2) - å¦‚æœå……é›»æ¨æœ‰å…©éš»æ§
        if (connectorCount >= 2) {
          const connector2Status = statusToRestore.connector2Status || "Preparing";
          const connector2Payload = {
            connectorId: 2,
            status: connector2Status,
            errorCode: "NoError",
            timestamp: timestamp.toISOString()
          };
          sendOcppRequest("StatusNotification", connector2Payload);
          logMsg(`ğŸ“¤ ç™¼é€å……é›»æ§2ç‹€æ…‹: connectorId=2, status=${connector2Status}`);
        }
        
        // æ¸…é™¤ä¿å­˜çš„ç‹€æ…‹
        savedStatusBeforeReset = {
          chargePointStatus: null,
          connectorStatus: null,
          connector2Status: null
        };
        sessionStorage.removeItem("savedStatusBeforeReset");
      }

      function Authorize() {
        sessionStorage.setItem("LastAction", "Authorize");
        var Auth = JSON.stringify([
          2,
          id,
          "Authorize",
          { idTag: $("#TAG").val() },
          // { idTag: "F0FDDD00C14A0000" },
        ]);
        _websocket.send(Auth);
        // é–‹å•Ÿèª¿æ•´å……é›»æ§è™Ÿ
        $("#CUID-connector").attr("disabled", false);
      }

      function startTransaction() {
        sessionStorage.setItem("LastAction", "startTransaction");
        $(".indicator").hide();
        $("#green").show();
        connector_locked = true;
        logMsg("Connector status changed to: " + connector_locked);
        var connectorId = parseInt($("#CUID-connector").val());
        console.log("connectorId", connectorId);
        
        // ä½¿ç”¨çµ±ä¸€çš„æ™‚é–“å–å¾—å‡½æ•¸
        const timestamp = getCurrentTimestamp();
        var strtT = JSON.stringify([
          2, 
          id,
          "StartTransaction",
          {
            connectorId: connectorId,
            idTag: $("#TAG").val(),
            // idTag: "",
            timestamp: timestamp.toISOString(),
            meterStart: parseInt($("#metervalue").val()),
            // reservationId: 0,
          },
        ]);
        console.log("start strtT = ", strtT);
        _websocket.send(strtT);
        // é–ä½èª¿æ•´å……é›»æ§è™Ÿ
        $("#CUID-connector").attr("disabled", true);


        setTimeout(() => {
          console.log("æ™šå€‹äº”ç§’");
          checkResrvedStart();
        }, 5000);
      }

      function stopTransaction() {
        sessionStorage.setItem("LastAction", "stopTransaction");
        $(".indicator").hide();
        connector_locked = false;
        logMsg("Connector status changed to: " + connector_locked);
        $("#yellow").show();

        // æ–°å¢åŠŸèƒ½: èª¿æ•´å……é›»æ™‚é–“
        // ä½¿ç”¨çµ±ä¸€çš„æ™‚é–“å–å¾—å‡½æ•¸
        const timestamp = getCurrentTimestamp();
        const duraionMin = $("#duration").val();
        console.log("duraionMin = ", duraionMin);
        let duration = parseInt(duraionMin, 10) * 60 * 1000;
        let stopTime = new Date(timestamp.getTime() + duration);
        console.log("stopTime = ", stopTime);

        var stpT = JSON.stringify([
          2,
          id,
          "StopTransaction",
          {
            transactionId: Number($("#transactionId").val()),
            idTag: $("#TAG").val(),
            timestamp: stopTime.toISOString(),
            meterStop: parseInt($("#metervalue").val()),
          },
        ]);
        _websocket.send(stpT);
        // é–‹å•Ÿèª¿æ•´å……é›»æ§è™Ÿ
        $("#CUID-connector").attr("disabled", false);
      }

      function handleData(data, request = false) {
        var lastAction = getLastAction();
        if ((lastAction = "BootNotification")) {
          data = data[2];
          heartbeat_interval = "40";
          return heartbeat_interval;
        } else if ((lastAction = "StartTransaction")) {
          return "StartTransaction";
        } else if (1 == 2) {
          alert("else");
        }
      }

      function getLastAction() {
        var LastAction = sessionStorage.getItem("LastAction");
        return LastAction;
      }

      function BootNotification() {
        var BN = JSON.stringify([
          2,
          id,
          "BootNotification",
          {
            chargePointVendor: "AVT-Company",
            chargePointModel: "AVT-Express",
            chargePointSerialNumber: "avt.001.13.1",
            chargeBoxSerialNumber: "avt.001.13.1.01",
            firmwareVersion: "0.9.87",
            iccid: "",
            imsi: "",
            meterType: "AVT NQC-ACDC",
            meterSerialNumber: "avt.001.13.1.01",
          },
        ]);

        logMsg("ws connected");

        _websocket.send(BN);
      }

      function startHB(interval) {
        logMsg("Setting heartbeat interval to " + interval);
        setInterval(send_heartbeat, interval);
      }

      function send_heartbeat() {
        sessionStorage.setItem("LastAction", "Heartbeat");
        var HB = JSON.stringify([2, id, "Heartbeat", {}]);
        _websocket.send(HB);
      }

      function send_meterValue() {
        console.log("mv");

        sessionStorage.setItem("LastAction", "MeterValues");
        var MV = JSON.stringify([
          2, 
          id,
          "MeterValues",
          JSON.parse($("#metervalueDisplay").text().trim())
        ]);

        _websocket.send(MV);
      }

      $(document).ready(function () {

        // å®šæœŸæ›´æ–°é¡¯ç¤º
        const meterValueInterval = setInterval(() => {
          const disconnectMins = Number($(`#disconnectMins`).val())

          // ä½¿ç”¨çµ±ä¸€çš„æ™‚é–“å–å¾—å‡½æ•¸
          const sendDate = getCurrentTimestamp();
          sendDate.setTime(sendDate.getTime() - disconnectMins * 60 * 1000)
          $("#metervalueDisplay").text(`
            {
                "connectorId": ${$("#CUID-connector").val()},
                "transactionId": ${$("#transactionId").val()},
                "meterValue": [
                    {
                        "timestamp":  "${sendDate.toISOString()}",
                        "sampledValue": [
                            {
                                "value": "${$("#metervalueVoltage").val()}",
                                "context": "Transaction.Begin",
                                "format": null,
                                "measurand": "Voltage",
                                "phase": "L1",
                                "location": "Outlet",
                                "unit": "V"
                            },
                            {
                                "value": "${$("#metervalueCurrnet").val()}",
                                "context": "Transaction.Begin",
                                "format": null,
                                "measurand": "Current.Import",
                                "phase": "L1",
                                "location": "Outlet",
                                "unit": "A"
                            },
                            {
                                "value": "${$("#metervaluePower").val()}",
                                "context": "Transaction.Begin",
                                "format": null,
                                "measurand": "Power.Active.Import",
                                "phase": null,
                                "location": "Outlet",
                                "unit": "W"
                            },
                            {
                                "value": "38",
                                "context": "Transaction.Begin",
                                "format": null,
                                "measurand": "Temperature",
                                "phase": null,
                                "location": "Body",
                                "unit": "Celsius"
                            },
                            {
                                "value": "${$("#metervalueSoC").val()}",
                                "context": "Transaction.Begin",
                                "format": null,
                                "measurand": "SoC",
                                "phase": null,
                                "location": "EV",
                                "unit": "Percent"
                            },
                            {
                                "value": "${$("#metervaluePower").val()}",
                                "context": "Transaction.Begin",
                                "format": null,
                                "measurand": "Power.Offered",
                                "phase": null,
                                "location": "Outlet",
                                "unit": "W"
                            },
                            {
                                "value": "${$("#metervalue").val()}",
                                "context": "Transaction.Begin",
                                "format": null,
                                "measurand": "Energy.Active.Import.Register",
                                "phase": null,
                                "location": "Outlet",
                                "unit": "Wh"
                            }
                        ]
                    }
                ]
            }
          `)
        }, 2000);

        $(".indicator").hide();
        $("#red").show();

        // è‡ªå‹•åŒæ­¥æ™‚é–“é–‹é—œ
        $("#auto-sync-time").on("change", function() {
          if ($(this).is(":checked")) {
            logMsg("ğŸ”„ å·²å•Ÿç”¨è‡ªå‹•åŒæ­¥ç³»çµ±æ™‚é–“ï¼Œå°‡åœ¨ä¸‹æ¬¡ Heartbeat å›æ‡‰æ™‚åŒæ­¥");
            $("#time-mode-indicator").text("æ¨¡å¼: ç­‰å¾…åŒæ­¥...").css("color", "#f39c12");
          } else {
            // å–æ¶ˆè‡ªå‹•åŒæ­¥æ™‚ï¼Œå¦‚æœç•¶å‰æ˜¯è‡ªå‹•åŒæ­¥æ¨¡å¼ï¼Œå‰‡æ¢å¾©å¯¦éš›æ™‚é–“
            if ($("#time-mode-indicator").text().includes("è‡ªå‹•åŒæ­¥")) {
              useCustomTime = false;
              baseTimestamp = null;
              baseRealTime = null;
              $("#time-mode-indicator").text("æ¨¡å¼: å¯¦éš›æ™‚é–“").css("color", "#999");
              $("#last-sync-time").text("");
              logMsg("å·²å–æ¶ˆè‡ªå‹•åŒæ­¥ï¼Œæ¢å¾©ä½¿ç”¨å¯¦éš›æ™‚é–“");
            }
          }
        });

        // æ‰‹å‹•å¥—ç”¨åŸºæº–æ™‚é–“æŒ‰éˆ•
        $("#apply-base-time").click(function() {
          const inputValue = $("#base-timestamp").val();
          if (!inputValue) {
            alert("è«‹å…ˆé¸æ“‡æ™‚é–“ï¼");
            return;
          }
          
          // å¦‚æœå•Ÿç”¨äº†è‡ªå‹•åŒæ­¥ï¼Œå…ˆå–æ¶ˆå®ƒ
          if ($("#auto-sync-time").is(":checked")) {
            $("#auto-sync-time").prop("checked", false);
            $("#last-sync-time").text("");
          }
          
          // å°‡ datetime-local çš„å€¼è½‰æ›ç‚º Date ç‰©ä»¶ï¼ˆæœ¬åœ°æ™‚é–“ï¼‰
          baseTimestamp = new Date(inputValue);
          // è¨˜éŒ„æŒ‰ä¸‹æŒ‰éˆ•æ™‚çš„å¯¦éš›æ™‚é–“
          baseRealTime = Date.now();
          // å•Ÿç”¨è‡ªè¨‚æ™‚é–“æ¨¡å¼
          useCustomTime = true;
          
          $("#time-mode-indicator").text("æ¨¡å¼: æ‰‹å‹•è¨­å®š").css("color", "#27a3ac");
          logMsg(`å·²æ‰‹å‹•å¥—ç”¨åŸºæº–æ™‚é–“: ${baseTimestamp.toISOString()} (UTC)`);
          console.log("baseTimestamp:", baseTimestamp);
          console.log("baseRealTime:", new Date(baseRealTime));
        });

        // æ¢å¾©å¯¦éš›æ™‚é–“æŒ‰éˆ•
        $("#reset-base-time").click(function() {
          useCustomTime = false;
          baseTimestamp = null;
          baseRealTime = null;
          $("#auto-sync-time").prop("checked", false);
          $("#time-mode-indicator").text("æ¨¡å¼: å¯¦éš›æ™‚é–“").css("color", "#999");
          $("#last-sync-time").text("");
          logMsg("å·²æ¢å¾©ä½¿ç”¨å¯¦éš›æ™‚é–“æ¨¡å¼");
        });

        // æ˜¯å¦å®šæœŸç™¼é€?
        let periodSendHandler = null;
        $(`#isPeriodSend`).on("change", function() {
          const meterValuesInterval = Number($(`#meterValuesInterval`).val());
          if ($(this).is(":checked")) {
            console.log(`å®šæœŸç™¼é€`);
            periodSendHandler = setInterval(() => {
              const incrementMeter = Number($("#metervalue").val()) + 50;
              const incrementSoC = Number($("#metervalueSoC").val()) + 1;
              console.log(`incrementMeter ==> ${incrementMeter}`);
              console.log(`incrementSoC ==> ${incrementSoC}`);
              $("#metervalue").val(incrementMeter);
              $("#metervalueSoC").val(incrementSoC);
              setTimeout(() => {
                send_meterValue();
              }, 500)
            }, meterValuesInterval * 1000);
          } else {
            console.log(`ç„¡å‹¾é¸`);
            if (!!periodSendHandler) {
              clearInterval(periodSendHandler);
            }
          }
        })
        // æ–°å¢ç‚º Inputbox ä¿®æ”¹ä¹Ÿæ›´æ–° Interval äº‹ä»¶
        $("#meterValuesInterval").on("change", () => {
          const meterValuesInterval = Number($(`#meterValuesInterval`).val());
          if ($('##isPeriodSend').is(":checked")) {
            console.log(`å®šæœŸç™¼é€`);
            periodSendHandler = setInterval(() => {
              const incrementMeter = Number($("#metervalue").val()) + 50;
              const incrementSoC = Number($("#metervalueSoC").val()) + 1;
              console.log(`incrementMeter ==> ${incrementMeter}`);
              console.log(`incrementSoC ==> ${incrementSoC}`);
              $("#metervalue").val(incrementMeter);
              $("#metervalueSoC").val(incrementSoC);
              setTimeout(() => {
                send_meterValue();
              }, 500)
            }, meterValuesInterval * 1000);
          } else {
            console.log(`ç„¡å‹¾é¸`);
            if (!!periodSendHandler) {
              clearInterval(periodSendHandler);
            }
          }
        })

        // å®šæœŸç™¼é€æç¤ºæ¡†é¡¯ç¤º
        $("#meterInterInfo").on("mouseover", function() {
          $(`#meterValueInfoContainer`).css("display", "block");
        })
        $("#meterInterInfo").on("mouseout", function() {
          $(`#meterValueInfoContainer`).css("display", "none");
        })

        //bind controls
        $("#connect").click(function () {
          console.log("é€£ç·šæŒ‰éˆ•è¢«é»æ“Š");
          $(".indicator").hide();
          $("#console").html("");
          if (!_websocket) {
            wsConnect();
          } else {
            _websocket.close(3001);
            _websocket = null;
            $("#connect").text("Connect").css("background", "#369");
          }
        });

        $("#send").click(function () {
          Authorize();
        });

        // æ¸¬è©¦ç‰¹æ®Šæµç¨‹
        $("#test-flow-btn").click(function () {
/**
1. çµæŸäº¤æ˜“å‰, å…ˆå‚³å…¥çš„çµæŸç‹€æ…‹(venderErrorCode="0x100203")
    2025-07-23 15:01:23.060 StatusNotification['Finishing']
    <- 2025-07-23 15:01:23.061 å›æ‡‰
(ç›¸éš”ç´„0.2ç§’)
2. çµæŸäº¤æ˜“å‰, æœ€å¾Œä¸€ç­† MeterValues
    2025-07-23 15:01:23.217 MeterValues
    <- 2025-07-23 15:01:23.218 å›æ‡‰
(ç›¸éš”ç´„0.15ç§’)
3. çµæŸäº¤æ˜“è™•ç†
    2025-07-23 15:01:23.355
    <- 2025-07-23 15:01:23.356 å›æ‡‰
(ç›¸éš”ç´„1.5ç§’)
4. çµæŸäº¤æ˜“å¾Œæ‹”æ§(Available)
    2025-07-23 15:01:24.850 StatusNotification['Available']
    <- 2025-07-23 15:01:27.296 å›æ‡‰
(ç›¸éš”ç´„6ç§’)
5. æ‹”æ§å¾Œåˆå‚³æ•…éšœ(Faulted): ConnectorIdæ˜¯2çš„, 0è·Ÿ1ä¹Ÿæœ‰ä¸€èµ·å‚³(VenderErrorCode="0x10020c")
    2025-07-23 15:02:33.777
    <- 2025-07-23 15:02:33.778 å›æ‡‰
(ç›¸éš”ç´„5ç§’)
6. æ•…éšœå¾Œç‹€æ…‹éƒ½å›ä¾†ç©ºé–‘(Available): ConnectorIdæ˜¯2çš„, 0è·Ÿ1ä¹Ÿæœ‰ä¸€èµ·å‚³
    2025-07-23 15:02:38.077
    <- ??? å›æ‡‰
*/
          // 1. çµæŸäº¤æ˜“å‰, å…ˆå‚³å…¥çš„çµæŸç‹€æ…‹(venderErrorCode="0x100203")
          $("#connector-vendorErrorCode").val("0x200205");
          triggerStatus("Finishing");

          // 2. çµæŸäº¤æ˜“å‰, æœ€å¾Œä¸€ç­† MeterValues
          send_meterValue();

          // 4. çµæŸäº¤æ˜“å¾Œæ‹”æ§(Available)
          $("#connector-vendorErrorCode").val("");
          triggerStatus("Available");

          // 3. çµæŸäº¤æ˜“è™•ç†
          // stopTransaction();

          // 5. æ‹”æ§å¾Œåˆå‚³æ•…éšœ(Faulted): ConnectorIdæ˜¯2çš„, 0è·Ÿ1ä¹Ÿæœ‰ä¸€èµ·å‚³(VenderErrorCode="0x10020c")
          /*
          setTimeout(() => {
            // ä¸‰ç­†é™¸çºŒå‚³å…¥æ•…éšœ
            [0, 1, 2].forEach(connectorId => {
              $("#CUID-connector").val(connectorId);
              setTimeout(() => {
                $("#connector-vendorErrorCode").val("0x10020c");
                triggerStatus("Faulted");
              }, 150)
            });
          }, 1500 + 6000);
          */

          /*
          // 6. æ•…éšœå¾Œç‹€æ…‹éƒ½å›ä¾†ç©ºé–‘(Available)
          setTimeout(() => {    
            // ä¸‰ç­†é™¸çºŒå‚³å…¥æ•…éšœ
            [0, 1, 2].forEach(connectorId => {
              setTimeout(() => {
                $("#CUID-connector").val(connectorId);
                $("#connector-vendorErrorCode").val("");
                triggerStatus("Available");
              }, 150)
            });
          }, 1500 + 6000 + 5000); 
          */

        });

        $("#start").click(function () {
          // èª¿æ•´ç‹€æ…‹ç‚ºå……é›»ä¸­, è§¸ç™¼æŒ‰éˆ•äº‹ä»¶
          startTransaction();
        });

        $("#stop").click(function () {
          // èª¿æ•´ç‹€æ…‹ç‚ºçµæŸå……é›», è§¸ç™¼æŒ‰éˆ•äº‹ä»¶
          stopTransaction();
          setTimeout(() => {
            console.log("æ™šå€‹äº”ç§’");
            triggerStatus("Finishing");
          }, 5000);
        });
        $("#mv").click(function () {
          send_meterValue();
        });
        $("#mvp").click(function () {
          var i = Number($("#meterInterval").val());
          var timesRun = 0;
          var interval = setInterval(function () {
            timesRun += 1;
            var val = Number($("#metervalue").val());
            var incrementvalue = Number($("#meterIncrement").val());
            var counter = Number($("#meterSendTimes").val());
            var Myelement = document.getElementById("metervalue");
            console.log(Myelement.value);
            Myelement.value = (val + incrementvalue).toString();;
            console.log("mvp", val, incrementvalue, interval, counter);
            if (timesRun === counter) {
              timesRun = 0;
              clearInterval(interval);
            }
            //do whatever here..
            send_meterValue();
          }, i);
        });

        $("#heartbeat").click(function () {
          send_heartbeat();
        });

        $("#ConnectorStatus").on("change", function() {
          $("#status").click();
        });

        $("#status").click(function () {
          sessionStorage.setItem("LastAction", "StatusNotification");

          // ä½¿ç”¨çµ±ä¸€çš„æ™‚é–“å–å¾—å‡½æ•¸
          const timestamp = getCurrentTimestamp();
          
          // å»ºæ§‹ StatusNotification payloadï¼ŒåªåŒ…å«æœ‰å€¼çš„æ¬„ä½
          const payload = {
            connectorId: parseInt($("#CUID").val()),
            status: $("#ConnectorStatus").val(),
            errorCode: "NoError",
            timestamp: timestamp.toISOString()
          };
          
          // åªæœ‰ç•¶ vendorErrorCode æœ‰å€¼æ™‚æ‰åŠ å…¥
          const vendorErrorCode = $("#cp-vendorErrorCode").val();
          if (vendorErrorCode && vendorErrorCode.trim() !== "") {
            payload.vendorErrorCode = vendorErrorCode;
          }
          
          // ä½¿ç”¨è¿½è¹¤å‡½æ•¸ç™¼é€
          const sentJson = sendOcppRequest("StatusNotification", payload);
          
          console.log(`ğŸ“¤ [å……é›»æ¨] ç™¼é€ StatusNotification:`);
          console.log(`   MessageId: ${id}`);
          console.log(`   Payload:`, payload);
          console.log(`   å®Œæ•´JSON: ${sentJson}`);
          logMsg(`ğŸ“¤ ç™¼é€ StatusNotification (å……é›»æ¨): connectorId=${payload.connectorId}, status=${payload.status}`);
        });

        $("#ConnectorStatus-connector").on("change", function() {
          $("#status-connector").click();
        });

        $("#status-connector").click(function () {
          sessionStorage.setItem("LastAction", "StatusNotification");

          // ä½¿ç”¨çµ±ä¸€çš„æ™‚é–“å–å¾—å‡½æ•¸
          const timestamp = getCurrentTimestamp();
          
          // å»ºæ§‹ StatusNotification payloadï¼ŒåªåŒ…å«æœ‰å€¼çš„æ¬„ä½
          const payload = {
            connectorId: parseInt($("#CUID-connector").val()),
            status: $("#ConnectorStatus-connector").val(),
            errorCode: "NoError",
            timestamp: timestamp.toISOString()
          };
          
          // åªæœ‰ç•¶ vendorErrorCode æœ‰å€¼æ™‚æ‰åŠ å…¥
          const vendorErrorCode = $("#connector-vendorErrorCode").val();
          if (vendorErrorCode && vendorErrorCode.trim() !== "") {
            payload.vendorErrorCode = vendorErrorCode;
          }
          
          // ä½¿ç”¨è¿½è¹¤å‡½æ•¸ç™¼é€
          const sentJson = sendOcppRequest("StatusNotification", payload);
          
          console.log(`ğŸ“¤ [å……é›»æ§] ç™¼é€ StatusNotification:`);
          console.log(`   MessageId: ${id}`);
          console.log(`   Payload:`, payload);
          console.log(`   å®Œæ•´JSON: ${sentJson}`);
          logMsg(`ğŸ“¤ ç™¼é€ StatusNotification (å……é›»æ§): connectorId=${payload.connectorId}, status=${payload.status}`);
        });

        $("#data_transfer").click(function () {
          sessionStorage.setItem("LastAction", "DataTransfer");
          var DT = JSON.stringify([
            2,
            id,
            "DataTransfer",
            {
              vendorId: "rus.avt.cp",
              messageId: "GetChargeInstruction",
              data: "",
            },
          ]);
          _websocket.send(DT);
        });

        // hsiwei{5/35}:æ–°å¢éŸŒé«”ç›¸é—œæŒ‰éˆ•ç›£è½äº‹ä»¶
        $("#Diagnostics-Status-Notification").click(function() {
          sessionStorage.setItem("LastAction", "DiagnosticsStatusNotification");
          var DT = JSON.stringify([
            2,
            id,
            "DiagnosticsStatusNotification",
            {
              status: $("#DiagnosticsStatus").val()
            },
          ]);
          _websocket.send(DT);
        });

        // hsiwei{5/35}:æ–°å¢éŸŒé«”ç›¸é—œæŒ‰éˆ•ç›£è½äº‹ä»¶
        $("#Firmware-Status-Notification").click(function() {
          sessionStorage.setItem("LastAction", "FirmwareStatusNotification");
          var DT = JSON.stringify([
            2,
            id,
            "FirmwareStatusNotification",
            {
              status: $("#FirmwareStatus").val()
            },
          ]);
          _websocket.send(DT);
        });

        // hsiwei{3/14}:æ–°å¢è‡ªå®šç¾©æ¸¬è©¦ç”¨é€å‡ºè¨Šæ¯æŒ‰éˆ•
        $("#cus-send").click(function() {
          var message = $("#message-input").val();
          console.log("message = ", message);

          // é€å‡ºè¨Šæ¯
          _websocket.send(message.trim());
          alert("é€å‡ºè¨Šæ¯");
        });

        // hsiwei{3/14}:ä¿®æ”¹inputå…§å®¹é€£å‹•é¡¯ç¤ºå…§å®¹
        $("#message-input").change(function(e) {
          var message = $(this).val();
          console.log("message = ", message);
          try {
            var json = JSON.parse(message);
            $("#message-preview").text(json);
          } catch (e) {
            console.error("error = ", e);
            $("#message-preview").text(message);
          }
        })

        $("#connect").on("change", function () {
          if (_websocket) {
            _websocket.close(3001);
          }
        });
      });
    </script>
  </body>
</html>
